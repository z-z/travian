// ==UserScript==
// @name       TravianScripts
// @author z-z
// @description Предоставляет всякие вспомогательные функции, типа ResourceBar
// @version 1.0.3
// @grant none
// @include http://*.travian.*
// @exclude *gettertools*
// @exclude *tactics*
// @exclude *ks4*
// ==/UserScript==

function getStorageConstructor(e,t,a){var s={villages:{},sum:t,all:0,show:!0,names:{}};return s.villages[e]=t,s.all=t.l1+t.l2+t.l3+t.l5,s.names[e]=a,s}function toTime(e){var t=parseInt(e,10),a=Math.floor(t/3600),s=Math.floor((t-3600*a)/60),i=t-3600*a-60*s,l=a+" ч. "+s+" мин. "+i+" сек.";return l}function xy2id(e,t){return 1+(parseInt(e)+400)+801*Math.abs(parseInt(t)-400)}function getVidFromCoords(e){var t=new Array;return/coordinateX/.test(e)?(e=e.replace(/([\u2000-\u20ff])/g,""),t[1]=e.match(/coordinateX.+?(-?\d{1,3})/)[1],t[2]=e.match(/coordinateY.+?(-?\d{1,3})/)[1]):t=e.match(/\((-?\d{1,3})\D+?(-?\d{1,3})\)/),t?xy2id(t[1],t[2]):-1}$$(".little_res").setStyle("color","red").each(function(e){var t=e.get("class");t=t.split(" ");var a=t[1].replace("r","l"),s=parseInt(e.get("text")),i=parseInt($(a).get("text").replace(".","")),l=s-i,r=resources.production["l"+(e.getParent().getChildren(".resources").indexOf(e)+1)];console.log(r),l=l/r*3600,e.set("html",'<img class="r'+(e.getParent().getChildren(".resources").indexOf(e)+1)+'" src="img/x.gif">'+s+' <font color="#99C01A">('+(i-s)+" - "+toTime(l)+")</font>")});var villageId=parseInt($$("#sidebarBoxVillagelist a.active").get("href")[0].split("=")[1]),villageName=$$("#sidebarBoxVillagelist a.active").getChildren(".name")[0].get("html")[0],villageProd=resources.production,gameNik=$$(".playerName").get("text")[0].substr(1),storageName="resStor_"+gameNik+"_"+Travian.Game.worldId+"_x"+Travian.Game.speed;if(null==localStorage.getItem(storageName))localStorage.setItem(storageName,JSON.encode(getStorageConstructor(villageId,villageProd,villageName)));else{var tempStor=JSON.decode(localStorage.getItem(storageName));tempStor.villages[villageId]=villageProd,tempStor.sum={};for(var i in tempStor.villages)for(var j=1;5>=j;j++)tempStor.sum["l"+j]||(tempStor.sum["l"+j]=0),tempStor.sum["l"+j]+=tempStor.villages[i]["l"+j];tempStor.all=tempStor.sum.l1+tempStor.sum.l2+tempStor.sum.l3+tempStor.sum.l5,tempStor.names[villageId]||(tempStor.names[villageId]=villageName),$$("#sidebarBoxVillagelist li > a").each(function(e){var t=parseInt(e.get("href").split("=")[1]),a=e.getChildren(".name")[0].get("html");tempStor.names[t]&&tempStor.names[t]!=a&&(tempStor.names[t]=a)}),localStorage.setItem(storageName,JSON.encode(tempStor))}var dat=JSON.decode(localStorage.getItem(storageName)),dorfs="";for(var z in dat.names)dorfs+="<b>"+dat.names[z]+"</b>&nbsp;&nbsp;";var htm='<div id="resBox" class="sidebarBox toggleable"> <div class="sidebarBoxBaseBox"> <div class="baseBox baseBoxTop"> <div class="baseBox baseBoxBottom"> <div class="baseBox baseBoxCenter"></div></div></div></div><div class="sidebarBoxInnerBox"> <div class="innerBox header "><br><div class="boxTitle">ЧВР аккаунта</div></div><div class="innerBox content"><ul><li><img class="r1Big" src="img/x.gif" alt="">&nbsp;&nbsp;&nbsp;=&nbsp;&nbsp;&nbsp;'+dat.sum.l1+'</li><li><img class="r2Big" src="img/x.gif" alt="">&nbsp;&nbsp;&nbsp;=&nbsp;&nbsp;&nbsp;'+dat.sum.l2+'</li><li><img class="r3Big" src="img/x.gif" alt="">&nbsp;&nbsp;&nbsp;=&nbsp;&nbsp;&nbsp;'+dat.sum.l3+'</li><li><img class="r4Big" src="img/x.gif" alt="">&nbsp;&nbsp;&nbsp;=&nbsp;&nbsp;&nbsp;'+dat.sum.l4+"</li><li>&nbsp;</li><li><b>Всего:&nbsp;&nbsp;&nbsp;"+dat.all+"</b></li><li>&nbsp;</li><li>Учтены деревни:</li><li>"+dorfs+'</li></ul> </div><div class="innerBox footer"><button type="button" class="toggle" onclick=""><div class="button-container addHoverClick "></div></button> </div></div></div>';if(dat.show){var el=Elements.from(htm);el[0].inject($("sidebarBoxHero"),"after")}$("resBox").down("button.toggle").addEvent("click",function(){Travian.Game.Layout.toggleBox($("resBox"),"travian_toggle","res")});var gpackNum=/gpack.travian.com\/(\d+)/gim.exec(document.documentElement.outerHTML)[1],resImg=new Element("img",{"class":"reportInfo carry full",src:"img/x.gif",styles:{width:"13px",height:"12px",position:"relative",background:"url(http://gpack.travian.com/"+gpackNum+"/img/a/carry.gif)",top:"2px",left:0}}),resLink=new Element("a",{href:"#",styles:{position:"absolute",width:"auto",height:"auto",padding:0,margin:0,top:"0px",left:"150px"}});resImg.inject(resLink);var defImg=new Element("img",{"class":"def2",src:"img/x.gif",styles:{width:"16px",height:"16px",position:"relative",background:"url(http://gpack.travian.com/"+gpackNum+"/img/a/def2.gif)",top:0,left:0}}),defLink=new Element("a",{href:"#",styles:{position:"absolute",width:"auto",height:"auto",padding:0,margin:0,top:"0px",left:"130px"}});defImg.inject(defLink),$$("#sidebarBoxVillagelist li").each(function(e){if(!e.hasClass("active")){var t=e.getElement("span").get("html"),a="build.php?gid=17&t=5&z="+getVidFromCoords(t),s="build.php?gid=16&tt=2&z="+getVidFromCoords(t);resLink.clone().set("href",a).inject(e),defLink.clone().set("href",s).inject(e)}}),$$("#overview tr").each(function(e){e.getChildren()[1].hasClass("newMessage")&&(e.getChildren()[0].getChildren()[0].checked=!0)});
